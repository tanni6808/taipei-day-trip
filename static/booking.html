<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/src/css/style.css" />
    <script>
      (async function () {
        try {
          const token = localStorage.getItem("token");
          if (!token) return (window.location.href = "/");
          const headers = { Authorization: "Bearer " + token };
          const response = await fetch("/api/user/auth", {
            headers,
          });
          const data = await response.json();
          if (data.data === null) return (window.location.href = "/");
        } catch (err) {
          console.log(err);
          window.location.href = "/";
        }
      })();
    </script>
    <script defer src="/script.js"></script>
    <script defer src="/booking.js"></script>
  </head>
  <body>
    <nav class="nav">
      <div class="nav__container">
        <h2 class="nav__title"><a href="/">台北一日遊</a></h2>
        <ul class="nav__list">
          <li id="btn-booking">預定行程</li>
          <li>登出系統</li>
        </ul>
      </div>
      <hr />
    </nav>
    <main>
      <div class="container">
        <section class="booking">
          <h4>您好，<span id="user">使用者</span>，待預定的行程如下：</h4>
          <div class="booking__attraction">
            <img src="" alt="attraction" class="booking__attraction-image" />
            <div class="booking__attraction-info">
              <div class="booking__attraction-title bold">
                台北一日遊：<span></span>
              </div>
              <div class="booking__attraction-detail">
                <div class="booking__attraction-detail--label">日期：</div>
                <div class="booking__attraction-detail--date"></div>
              </div>
              <div class="booking__attraction-detail">
                <div class="booking__attraction-detail--label">時間：</div>
                <div class="booking__attraction-detail--time"></div>
              </div>
              <div class="booking__attraction-detail">
                <div class="booking__attraction-detail--label">費用：</div>
                <div class="booking__attraction-detail--price"></div>
              </div>
              <div class="booking__attraction-detail">
                <div class="booking__attraction-detail--label">地點：</div>
                <div class="booking__attraction-detail--address"></div>
              </div>
            </div>
            <img id="btn-delete" src="/src/img/icon/delete.png" alt="delete" />
          </div>
        </section>
        <hr />
        <section class="booking">
          <div class="booking__user-contact-info">
            <h4>您的聯絡資訊</h4>
            <form action="">
              <div class="form">
                <label for="contact-name">聯絡姓名：</label>
                <input type="text" name="contact-name" id="contact-name" />
              </div>
              <div class="form">
                <label for="">連絡信箱：</label>
                <input type="email" name="contact-email" id="contact-email" />
              </div>
              <div class="form">
                <label for="phone-number">手機號碼：</label>
                <input type="text" name="phone-number" id="phone-number" />
              </div>
            </form>
            <div class="caution">
              請保持手機暢通，準時到達，導覽人員將用手機與您聯繫，務必留下正確的連絡方式。
            </div>
          </div>
        </section>
        <hr />
        <section class="booking">
          <div class="booking__payment">
            <h4>信用卡付款資訊</h4>
            <!-- TapPay Field Container  -->
            <style>
              .tpfield {
                font-size: 16px;
                color: #000000;
                font-weight: bold;
                height: 38px;
                width: 200px;
                border-radius: 5px;
                border: 1px solid #e8e8e8;
                padding: 10px;
              }
              .tappay-field-focus {
                border: 2px solid black;
              }
              .has-error > .control-label {
                color: red !important;
              }
              .has-error > .form-control {
                border: 1px solid red !important;
              }
              .has-success > .control-label {
                color: green !important;
              }
              .has-success > .form-control {
                border: 1px solid green !important;
              }
            </style>
            <form id="tappay">
              <div class="form-group card-number-group">
                <label for="card-number" class="control-label"
                  >卡片號碼：</label
                >
                <div
                  class="tpfield form-control card-number"
                  id="card-number"
                ></div>
              </div>
              <div class="form-group expiration-date-group">
                <label for="expiration-date" class="control-label"
                  >過期時間：</label
                >
                <div
                  class="tpfield form-control expiration-date"
                  id="card-expiration-date"
                ></div>
              </div>
              <div class="form-group ccv-group">
                <label for="ccv" class="control-label">驗證密碼：</label>
                <div class="tpfield form-control ccv" id="card-ccv"></div>
              </div>
            </form>
          </div>
        </section>
        <hr />
        <section class="booking">
          <div class="booking__confirm">
            <div class="caution">總價：新台幣<span>2000</span>元</div>
            <button id="btn-confirm" type="submit" form="tappay" disabled>
              確認訂購並付款
            </button>
          </div>
        </section>
      </div>
    </main>
    <footer class="footer">COPYRIGHT &copy; 2021 台北一日遊</footer>
    <script src="https://js.tappaysdk.com/sdk/tpdirect/v5.19.2"></script>
    <script>
      TPDirect.setupSDK(
        159786,
        "app_0MVUSxxzks2dT9POjaxbqhJQy6gSExAnrDZGFEWnZ1dQPVF1zJllje4MOuIn",
        "sandbox"
      );
      var fields = {
        number: {
          // css selector
          element: "#card-number",
          placeholder: "**** **** **** ****",
        },
        expirationDate: {
          // DOM object
          element: document.getElementById("card-expiration-date"),
          placeholder: "MM / YY",
        },
        ccv: {
          element: "#card-ccv",
          placeholder: "後三碼",
        },
      };
      TPDirect.card.setup({
        fields: fields,
        styles: {
          // Style all elements
          input: {
            color: "gray",
          },
          // Styling ccv field
          "input.ccv": {
            // 'font-size': '16px'
          },
          // Styling expiration-date field
          "input.expiration-date": {
            // 'font-size': '16px'
          },
          // Styling card-number field
          "input.card-number": {
            // 'font-size': '16px'
          },
          // style focus state
          ":focus": {
            // 'color': 'black'
          },
          // style valid state
          ".valid": {
            color: "green",
          },
          // style invalid state
          ".invalid": {
            color: "red",
          },
          // Media queries
          // Note that these apply to the iframe, not the root window.
          "@media screen and (max-width: 400px)": {
            input: {
              color: "orange",
            },
          },
        },
        // 此設定會顯示卡號輸入正確後，會顯示前六後四碼信用卡卡號
        isMaskCreditCardNumber: true,
        maskCreditCardNumberRange: {
          beginIndex: 6,
          endIndex: 11,
        },
      });
      TPDirect.card.onUpdate(function (update) {
        const submitButton = document.getElementById("btn-confirm");
        update.canGetPrime === true;
        // --> you can call TPDirect.card.getPrime()
        if (update.canGetPrime) {
          // Enable submit Button to get prime.
          submitButton.removeAttribute("disabled");
        } else {
          // Disable submit Button to get prime.
          submitButton.setAttribute("disabled", true);
        }

        // // cardTypes = ['mastercard', 'visa', 'jcb', 'amex', 'unknown']
        // if (update.cardType === "visa") {
        //   // Handle card type visa.
        // }

        // number 欄位是錯誤的
        if (update.status.number === 2) {
          setNumberFormGroupToError(".card-number-group");
        } else if (update.status.number === 0) {
          setNumberFormGroupToSuccess(".card-number-group");
        } else {
          setNumberFormGroupToNormal(".card-number-group");
        }

        if (update.status.expiry === 2) {
          setNumberFormGroupToError(".expiration-date-group");
        } else if (update.status.expiry === 0) {
          setNumberFormGroupToSuccess(".expiration-date-group");
        } else {
          setNumberFormGroupToNormal(".expiration-date-group");
        }

        if (update.status.ccv === 2) {
          setNumberFormGroupToError(".ccv-group");
        } else if (update.status.ccv === 0) {
          setNumberFormGroupToSuccess(".ccv-group");
        } else {
          setNumberFormGroupToNormal(".ccv-group");
        }
      });
      function setNumberFormGroupToError(selector) {
        const element = document.querySelector(selector);
        if (!element) return;
        element.classList.add("has-error");
        element.classList.remove("has-success");
      }
      function setNumberFormGroupToSuccess(selector) {
        const element = document.querySelector(selector);
        if (!element) return;
        element.classList.remove("has-error");
        element.classList.add("has-success");
      }
      function setNumberFormGroupToNormal(selector) {
        const element = document.querySelector(selector);
        if (!element) return;
        element.classList.remove("has-error");
        element.classList.remove("has-success");
      }
      function isContactInfoValid() {
        const name = document.getElementById("contact-name").value;
        const email = document.getElementById("contact-email").value;
        const phone = document.getElementById("phone-number").value;
        return name !== "" && email !== "" && phone !== "";
      }
      function onSubmit(event) {
        event.preventDefault();
        if (!isContactInfoValid()) {
          return alert("請輸入完整聯絡資訊！");
        }
        // 取得 TapPay Fields 的 status
        const tappayStatus = TPDirect.card.getTappayFieldsStatus();

        // 確認是否可以 getPrime
        if (tappayStatus.canGetPrime === false) {
          alert("can not get prime");
          return;
        }

        // Get prime
        TPDirect.card.getPrime((result) => {
          if (result.status !== 0) {
            alert("get prime error " + result.msg);
            return;
          }
          alert("get prime 成功，prime: " + result.card.prime);
          console.log(result);
          // send prime to your server, to pay with Pay by Prime API .
          // Pay By Prime Docs: https://docs.tappaysdk.com/tutorial/zh/back.html#pay-by-prime-api
        });
      }
      document.getElementById("tappay").addEventListener("submit", onSubmit);
    </script>
  </body>
</html>
